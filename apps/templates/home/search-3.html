{% extends "layouts/base.html" %}

{% block title %} 문화재 검색 {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
    <style>
        .info-window {
            width: 240px;
            height: 100px;
        }
        .info-image {
            margin: 10px;
            width: 80px;
            height: 80px;
        }
        .info-text {
            margin: auto;
            font-size: small;
        }
    </style>
{% endblock stylesheets %}

{% block content %}

    <main>

        {% include 'includes/preloader.html' %}

        <!-- Header -->
        <section class="section section-header pb-7 bg-primary text-white">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-12 col-xl-8 text-center">
                        <h1 class="display-2 mb-3">문화재 검색</h1>
                    </div>
                </div>
            </div>
        </section>

        <section class="section section-lg">
            <div class="container">
                <div class="row">
                    <div class="col-3">
                        <div class="card shadow text-center">
                            <div class="card-header bg-white p-3">
                                <h3 class="text-primary mt-auto mb-auto">시대</h3>
                            </div>
                            <div class="card-body">
                                <div class="container">
                                    <div class="form-check text-left">
                                        <form method="post">

                                        </form>
                                        {% csrf_token %}
                                        <input class="form-check-input" type="checkbox" name="heritage" value="석기">석기<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="청동기">청동기<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="철기">철기<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="고구려">고구려<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="백제">백제<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="신라">신라<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="가야">가야<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="통일신라">통일신라<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="고려">고려<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="조선">조선<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="대한제국">대한제국<br>
                                        <input class="form-check-input" type="checkbox" name="heritage" value="일제강점기">일제강점기<br>
                                    </div>
                                    <div class="d-flex justify-content-between mt-4">
                                        <button class="btn btn-sm btn-primary" value="selectAll"><span class="fas fa-check-double"></span></button>
                                        <button class="btn btn-sm btn-primary" value="initCheckbox"><span class="fas fa-redo"></span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 지도 -->
                    <div class="col-9">
                        <div id="map" style="width:100%; height:100%;"></div>
                    </div>

                </div>
            </div>
        </section>
    </main>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% include 'includes/kakaomap.html' %}
<script>
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var csrftoken = getCookie('csrftoken');


    function reloadMap() {
        var container = document.getElementById("map");
        var options = {
            center: new kakao.maps.LatLng(35.834636328158915, 127.7235675736344),
            level: 14
        };
        map = new kakao.maps.Map(container, options);
        clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            minLevel: 10
        });
    }


    function ajax_load_data() {
        var checked_value = [];
        var obj_list;

        $("input:checkbox[name=heritage]:checked").each(function(i, box) {
            checked_value.push($(box).val());
        });

        $.ajax({
            type: "POST",
            url: "{% url 'search' %}",
            async: false,
            dataType: "json",
            data: {pcd1_list: JSON.stringify(checked_value)}  ,
            headers: {"X-CSRFToken": getCookie("csrftoken")},
            success: function(data) {
                obj_list = data;
                console.log(obj_list);
            },
            error: function(error) {
                console.log(error);
            }
        });
        return [obj_list, checked_value];
    }

    function addMarkerClusterer() {

        var values = ajax_load_data();
        var obj_list = values[0];
        var checked_value = values[1];

        if (checked_value.length > 0) {
            clusterer.clear();

            $.each(checked_value, function(i, value) {
                var detail_list = {{ obj_list|safe }}[value];
                var markers = $(detail_list).map(function(i, data) {
                    var marker = new kakao.maps.Marker({
                        position: new kakao.maps.LatLng(data.latitude, data.longitude),
                        clickable: true
                    });

                    var content = '<div class=info-window">'
                        + '<div class="row align-items-center">'
                            + '<div class="col-4">'
                                + '<img class="info-image" src=' + data.imageUrl +'>'
                            + '</div>'
                            + '<div class="col-8">'
                                + '<p class="info-text">'+ data.ccbaMnm1
                                + '<br>' + data.ccbaPcd1Nm + ' | ' + data.ccbaCtcdNm
                                + '<br>' + data.ccmaName + ' ' + data.crltsnoNm  + '호' +'</p>'
                            + '</div>'
                        + '</div>'
                    + '</div>';

                    var infowindow = new kakao.maps.InfoWindow({
                        content: content
                    });

                    kakao.maps.event.addListener(marker, "mouseover", function() {
                        infowindow.open(map, marker);
                    });
                    kakao.maps.event.addListener(marker, "mouseout", function() {
                        infowindow.close();
                    });
                    return marker;
                });
                clusterer.addMarkers(markers);
            });
        } else {
            reloadMap();
        }
    };

    $("input:checkbox[name=heritage]").on("click", addMarkerClusterer);


    $("button[value='initCheckbox']").on("click", function() {
        $("input:checkbox[name=heritage]").prop("checked", false);
        reloadMap();
    });


    $("button[value='selectAll']").on("click", function() {
        var len = $("input:checkbox[name='heritage']:checked").length;
        if (len == 12) {
            $("input:checkbox[name=heritage]").prop("checked", false);
        } else {
            $("input:checkbox[name=heritage]").prop("checked", true);
        }
        addMarkerClusterer();
    });


    $(document).ready(function() {
        reloadMap();
    });



</script>
{% endblock javascripts %}